trigger:
  branches:
    include:
    - dev
    - master
  paths:
    exclude:
    - '*/README.md'


pool:
  vmImage: 'windows-latest'

variables:
  - group: 'Package Versioning'
  - name: buildPlatform
    value: 'Any CPU'
  - name: buildConfiguration 
    value: 'Release'
  - name: buildDirPath 
    value: '$(Build.SourcesDirectory)\src\ReCaptcha\bin\$(buildPlatform)\$(buildConfiguration)'


jobs:
  - job: Init
    displayName: Initialize & Versioning
    steps:

      - powershell: | 
          if('$(Build.SourceBranch)' -eq 'refs/heads/master')
          {
            Write-Host "##vso[task.setvariable variable=version;isOutput=true]$(major).$(minor).$(patch)"
          }
          else
          {
            Write-Host "##vso[task.setvariable variable=version;isOutput=true]$(major).$(minor).$(patch)-ci$(Build.BuildId)"
          }
        displayName: Set Package Version
        name: package

  - job: BuildPack
    displayName: Build & Pack
    dependsOn: Init
    variables:
      - name: packageVersion
        value: $[ dependencies.Init.outputs['package.version'] ]
    steps:
    - task: MSBuild@1
      displayName: Build & Pack Project
      inputs:
        solution: '**/src/ReCaptcha/ReCaptcha.csproj'
        configuration: $(buildConfiguration)
        platform: $(buildPlatform)
        msbuildArguments: '/restore /t:Build /t:Pack /p:ContinuousIntegrationBuild=true /p:Deterministic=false /p:PackageVersion=$(packageVersion) /p:PackageOutputPath="$(buildDirPath)"'
        
    - task: PublishBuildArtifacts@1
      displayName: Publish Build Artifacts
      inputs:
        PathtoPublish: '$(buildDirPath)'
        ArtifactName: 'nuget'
        publishLocation: 'Container'

  - job: Test
    displayName: Run Unit Tests
    dependsOn: Init
    steps:
      - task: DotNetCoreCLI@2
        displayName: Run Tests
        inputs:
          command: 'test'
          publishTestResults: true
          projects: '**/tests/ReCaptcha.Tests/ReCaptcha.Tests.csproj'
          testRunTitle: 'Project Unit Tests'
          workingDirectory: '$(System.DefaultWorkingDirectory)'

  - deployment: PushArtifacts
    displayName: Push to Development Feed
    dependsOn: 
      - BuildPack
      - Test
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/dev'))
    environment: Development
    strategy:
      runOnce:
        deploy:
          steps:
            - download: current
              artifact: nuget
          
            - task: NuGetCommand@2
              inputs:
                command: 'push'
                packagesToPush: '$(Pipeline.Workspace)/**/*.nupkg;!$(Pipeline.Workspace)/**/*.symbols.nupkg'
                nuGetFeedType: 'internal'
                publishVstsFeed: '664acd3b-eaa2-47d0-a9a4-09c7e2741d7d'
                allowPackageConflicts: true

            - task: DownloadFile@1
              displayName: 'Download version bump script'
              inputs:
                FileUrl: 'https://gist.githubusercontent.com/jooni91/542239cd82a7087cc6ae45fdb2dba12d/raw/b8825640040beab059a3331c15b6a509ec869bd2/update-version-code-script.ps1'

            - task: PowerShell@2
              displayName: 'PowerShell Script'
              inputs:
                targetType: filePath
                filePath: './update-version-code-script.ps1'
                arguments: '$(System.AccessToken)'
